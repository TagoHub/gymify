- last_set = @exercise.exercise_group.exercises.flat_map{ |e| e.working_sets }.select{ |es| es.last_set? }.first 
#fixed-timer-bar
  .progress
    .progress-bar.bg-primary{
      role: "progressbar",
      style: "width: #{@progress}%",
      aria: {valuenow: (@progress).round, valuemin: "0", valuemax: "100"}
    }
  %h1#rest-timer 00:00
  .progress
    .progress-bar.bg-light#rest-progress{
      role: "progressbar",
      style: "width: 100%; transition: width linear;",
      aria: {valuenow: "100", valuemin: "0", valuemax: "100"}
    }
.flex-container
  .flex-item-left
    - if @exercise.image.attached?
      .image-wrapper{ data: { exercise_id: @exercise.id } }
        = image_tag @exercise.image, id: "exercise-image-#{@exercise.id}", class: "exercise-img", alt: @exercise.name, loading: "lazy"
        .spinner{id: "exercise-spinner-#{@exercise.id}", role: "status", aria: { hidden: "false" } }
          %i.bi.bi-arrow-repeat
    - else
      .image-placeholder
        %p.text-muted No image available
  .flex-item-right
    .play-area
      .flex-row
        .exercise-name.fs-3.text-center= @exercise.name
        = render 'exercise_sets/play_form'
      .show
        = render 'exercise_sets/exercise_info', exercise_set: @exercise_set, exercise: @exercise, upcoming: false
        - if last_set.next_set
          - upcoming_ex_sets = last_set.next_set.exercise.exercise_group.all_sets.select { |es| es.order == 1 }
          .accordion.accordion-flush.border-top.border-bottom#upcomingAccordion
            - upcoming_ex_sets.each_with_index do |ex_set, index|
              .accordion-item
                %h2.accordion-header{id: "heading-#{index}"}
                  %button.accordion-button.collapsed{
                    type: "button",
                    data: { "bs-toggle": "collapse", "bs-target": "#collapse-#{index}" },
                    aria: { expanded: "false", controls: "collapse-#{index}" }
                  }
                    = "Upcoming"
                    = " #{index+1}" if upcoming_ex_sets.size > 1
                    = " â€“ #{ex_set.exercise.name}"

                .accordion-collapse.collapse{
                  id: "collapse-#{index}",
                  aria: { labelledby: "heading-#{index}" },
                  data: { "bs-parent": "#upcomingAccordion" }
                }
                  .accordion-body
                    = render 'exercise_sets/exercise_info', exercise_set: ex_set, exercise: ex_set.exercise, upcoming: true
        = form_with model: last_set, url: program_workout_exercise_exercise_set_path(@program, @workout, last_set.exercise, last_set), method: :patch, local: true, html: { id: "next" } do |f|
          = f.hidden_field :play, value: true, id: "play-#{last_set.id}"
          = f.hidden_field :reps, value: last_set.reps, id: "reps-#{last_set.id}"
          = f.hidden_field :load, value: display_number(last_set.load), step: :any, id: "load-#{last_set.id}"
          = f.hidden_field :intensity, value: last_set.intensity, id: "intensity-#{last_set.id}"
          %button.h5.btn.btn-primary{ type: "submit", title: "Skip to next exercise", id: "next-link" } Next Exercise
        %br

:scss

  #fixed-timer-bar {
    position: sticky;
    top: 0;
    left: 0;
    right: 0;
    z-index: 2;
    background: rgba(32, 32, 32, 0.95);
    color: #fff;
    text-align: center;
    padding: 0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  #fixed-timer-bar .progress { margin: 0; border-radius: 0; }
  #fixed-timer-bar h1 { margin: 0.4rem 0; }
  .flex-container { display: flex; flex-direction: column; }
  .flex-item-left, .flex-item-right { width: 100%; }
  .exercise-name {
    text-align: center;
    font-weight: 700;
    color: #333;
    background: transparent;
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }
  .current-set-row { scroll-margin-top: 110px; }
  .image-wrapper {
    width: 100%;
    min-height: 320px; /* reserve vertical space on mobile */
    height: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
    background: transparent;
    .exercise-img {
      visibility: hidden;
      opacity: 0;
      transition: opacity 220ms ease;
      max-width: 500px; /* mobile cap */
      width: 100%;
      height: auto;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }
    .spinner {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      animation: spin 1s linear infinite;
      color: rgba(0,0,0,0.6);
      background: transparent;
      z-index: 2;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  }
  .image-placeholder { width: 100%; height: 200px; display:flex; align-items:center; justify-content:center; background: #f8f9fa; color: #6c757d; }
  .play-area { padding: 1rem; padding-top: 0; }
  .show form { border: none; }
  form#next { max-width: 100%; padding: 0; margin: 0; align-items: center; display: flex; justify-content: center; }
  #next-link { margin-top: 20px; margin-bottom: 20px; }
  .flex-row { align-items: flex-start; }
  .disabled-link { opacity: 0.5; }
  .show td.label { width: 30%; }
  .accordion-body { padding: 0; }
  .progress {
    background-color: rgba(255, 255, 255, 0);
    border-radius: 0;
    height: 6px;
    width: 100%;
    overflow: hidden;
    .progress-bar { height: 100%; transition: width 0.4s ease; }
  }
  @media (min-width: 1000px) {
    .flex-container { flex-direction: row; height: calc(100vh - 88px); }

    .flex-item-left {
      width: 50%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      overflow: hidden;
      background: transparent;
    }

    .flex-item-right {
      width: 50%;
      height: 100%;
      overflow: auto;
      display: flex;
      flex-direction: column;
      background: #fff;
      padding: 1.25rem;
    }
    .exercise-name { padding: 0.75rem 1rem; font-size: 1.5rem; color: #222; background: transparent; text-align: center; }

    .image-wrapper {
      width: 100%;
      height: 100%; /* fill left column fully */
      min-height: 420px;
      justify-content: center;
      background: transparent;
      .exercise-img {
        visibility: hidden;
        opacity: 0;
        transition: opacity 220ms ease;
        max-width: 100%;
        width: 100%; /* fill left column horizontally */
        height: auto;
        max-height: 100%;
        object-fit: contain;
        margin: 0;
      }
      .spinner { display: flex; }
    }

    .play-area { position: sticky; top: 96px; z-index: 5; }

    /* Keep Next button centered on desktop too */
    form#next { justify-content: center; }
  }

:javascript

  document.addEventListener("DOMContentLoaded", () => {
    let time = 0;
    const notes = "#{@exercise_set&.exercise&.notes}" || "";
    const newExercise = #{@prev_set&.exercise != @exercise_set&.exercise};
    const intensityTechnique = "#{@exercise_set&.intensity_technique&.name}" || "";
    const prevSet = #{!!@prev_set};
    const workingSet = "#{@exercise_set&.set_type}" === "Working Set";
    const unilateral = #{@exercise_set&.exercise&.unilateral || false};
    const alternate = #{!!@alternate};
    const prevWorkingSet = #{@prev_set&.working_set? ? "true" : "false"};
    let duration = #{(@exercise_set&.exercise&.unilateral ? @exercise_set&.exercise&.rest_time : @prev_set&.exercise&.rest_time) || 0};
    const unit = "#{@prev_set&.exercise&.unit&.name || 'Seconds'}";
    // Notify user of exercise notes
    if (newExercise && notes) {
      showToast(notes, { type: "", icon: '<i class="bi bi-info-circle"></i>' });
    }
    // Notify user of intensity techniques
    if (!!intensityTechnique) {
      showToast("Apply " + intensityTechnique, { type: "danger", icon: '<i class="bi bi-rocket"></i>' })
    }
    // Set time based on previous set
    if (prevSet) {
      if (workingSet && prevWorkingSet) {
        time = duration
        // Convert to seconds if rest time is in minutes
        if (unit.toLowerCase() === "minutes") {
          time *= 60;
        }
      }
      // Set time to 30 seconds if warmup set
      else {
        time = 30;
      }
    }
    // Set time to 5 if workout just started
    else {
      time = 5;
    }
    // Reduce time by half for unilateral exercises
    if (unilateral) {
      time /= 2;
    }
    // Select timer element
    const timerEl = document.getElementById("rest-timer");
    if (!timerEl) return;
    // Update timer progress bar
    const restProgress = document.getElementById("rest-progress");
    const totalTime = time;
    if (restProgress) {
      restProgress.style.transitionDuration = `${totalTime}s`;
      restProgress.style.width = "0%";
    }
    // Update timer text and notify user if necessary
    const updateTimer = () => {
      // Notify if rest time is over
      // Play sound has a delay of 0.5 seconds
      if (time === 1) {
        setTimeout(() => {
          playSound();
        }, 500);
      }
      if (time <= 0) {
        if (unilateral) {
          if (alternate) {
            timerEl.innerHTML = `<i class="bi bi-rocket-takeoff text-primary me-2"></i>Do left side!`;
          }
          else {
            timerEl.innerHTML = `<i class="bi bi-rocket-takeoff text-primary me-2"></i>Do right side!`;
          }
        }
        else {
          timerEl.innerHTML = `<i class="bi bi-rocket-takeoff text-primary me-2"></i>Go!`;
        }
        clearInterval(interval);
        return;
      }
      // Change timer text to minutes:seconds format
      const minutes = Math.floor(time / 60);
      const seconds = time % 60;
      timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      time--;
    };

    updateTimer();
    const interval = setInterval(updateTimer, 1000);

    // Image loading with spinner
    const img = document.getElementById("exercise-image-#{@exercise.id}");
    const spinner = document.getElementById("exercise-spinner-#{@exercise.id}");
    if (img) {
      if (spinner) spinner.style.display = "flex";
      img.style.visibility = "hidden";
      img.style.opacity = "0";
      const reveal = () => {
        img.style.visibility = "visible";
        img.style.opacity = "1";
        if (spinner) spinner.style.display = "none";
      };
      if (img.complete) {
        reveal();
      } else if (img.decode) {
        img.decode().then(reveal).catch(() => {
          img.addEventListener("load", reveal);
          img.addEventListener("error", () => { if (spinner) spinner.style.display = "none"; });
        });
      } else {
        img.addEventListener("load", reveal);
        img.addEventListener("error", () => { if (spinner) spinner.style.display = "none"; });
      }
    }

    // Scroll to current set row if present (restore previous behaviour)
    setTimeout(() => {
      const setRowId = "set-row-#{@exercise_set&.id}";
      const el = document.querySelector('.current-set-row') || document.getElementById(setRowId);
      if (el && typeof el.scrollIntoView === 'function') el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 90);
  });